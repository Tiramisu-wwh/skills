#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
AI-Enhanced Java Security Vulnerability Scanner
Uses Claude's AI capabilities for semantic code analysis
"""

import os
import sys
import json
import time
import argparse
from pathlib import Path
from typing import List, Dict, Any
from datetime import datetime

class AIVulnerabilityScanner:
    """AI-enhanced vulnerability scanner using Claude's semantic analysis"""

    def __init__(self):
        self.scan_stats = {
            'files_analyzed': 0,
            'vulnerabilities_found': 0,
            'scan_duration': 0,
            'scan_time': None,
            'ai_confidence_scores': []
        }

    def discover_java_files(self, project_path: str) -> List[str]:
        """Discover all Java files in the project"""
        java_files = []
        project_root = Path(project_path)

        if not project_root.exists():
            raise ValueError(f"Project path does not exist: {project_path}")

        for java_file in project_root.rglob("*.java"):
            if "target/" not in str(java_file) and "build/" not in str(java_file):
                java_files.append(str(java_file))

        return java_files

    def analyze_code_with_ai(self, file_path: str, file_content: str) -> Dict[str, Any]:
        """
        ä½¿ç”¨Claude AIè¿›è¡ŒçœŸæ­£çš„Javaä»£ç å®‰å…¨è¯­ä¹‰åˆ†æ
        """

        # åŠ è½½å®‰å…¨è§„èŒƒæ–‡æ¡£ä½œä¸ºAIåˆ†æçš„å‚è€ƒ
        standards_path = Path(__file__).parent.parent / "references" / "java_security_standards.md"
        security_standards = ""
        try:
            with open(standards_path, 'r', encoding='utf-8') as f:
                security_standards = f.read()
        except Exception as e:
            print(f"Warning: Could not load security standards: {e}")

        # æ„é€ è¯¦ç»†çš„AIåˆ†æè¯·æ±‚
        ai_analysis_request = f"""
# Javaä»£ç å®‰å…¨è¯­ä¹‰åˆ†æè¯·æ±‚

## åˆ†æç›®æ ‡æ–‡ä»¶
**æ–‡ä»¶è·¯å¾„**: {file_path}
**åˆ†ææ—¶é—´**: {datetime.now().isoformat()}

## å®‰å…¨è§„èŒƒå‚è€ƒ
æˆ‘åŸºäºä»¥ä¸‹JAVAå®‰å…¨ç¼–ç å®¡è®¡è§„èŒƒè¿›è¡Œåˆ†æï¼š

{security_standards[:8000]}  # å–å‰8000å­—ç¬¦ä½œä¸ºå‚è€ƒ

## å¾…åˆ†æä»£ç 
```java
{file_content}
```

## åˆ†æè¦æ±‚

è¯·è¿›è¡Œæ·±åº¦çš„è¯­ä¹‰å®‰å…¨åˆ†æï¼Œè¶…è¶Šç®€å•çš„æ¨¡å¼åŒ¹é…ï¼š

### 1. ä»£ç ç†è§£å±‚é¢
- **ä¸šåŠ¡é€»è¾‘ç†è§£**: è¿™æ®µä»£ç çš„ä¸šåŠ¡ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿ
- **æ•°æ®æµåˆ†æ**: ç”¨æˆ·è¾“å…¥å¦‚ä½•æµç»è¿™ä¸ªå‡½æ•°ï¼Ÿ
- **ä¸Šä¸‹æ–‡ç†è§£**: è¿™ä¸ªç±»/æ–¹æ³•åœ¨æ•´ä¸ªåº”ç”¨ä¸­çš„ä½œç”¨ï¼Ÿ

### 2. å®‰å…¨æ¼æ´åˆ†æ
åŸºäºOWASP Top 10å’Œä¼ä¸šå®‰å…¨è§„èŒƒï¼Œé‡ç‚¹åˆ†æï¼š

**æ³¨å…¥æ”»å‡»ç±»**:
- SQLæ³¨å…¥ï¼šæ˜¯å¦æœ‰ç”¨æˆ·è¾“å…¥ç›´æ¥æ‹¼æ¥åˆ°SQLä¸­ï¼Ÿ
- å‘½ä»¤æ³¨å…¥ï¼šæ˜¯å¦æœ‰ç”¨æˆ·è¾“å…¥ç›´æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Ÿ
- SpELæ³¨å…¥ï¼šSpringè¡¨è¾¾å¼æ˜¯å¦æœ‰ç”¨æˆ·è¾“å…¥ï¼Ÿ

**è·¨ç«™è„šæœ¬ç±»**:
- åå°„å‹XSSï¼šç”¨æˆ·è¾“å…¥æ˜¯å¦ç›´æ¥è¾“å‡ºåˆ°HTMLï¼Ÿ
- å­˜å‚¨å‹XSSï¼šç”¨æˆ·è¾“å…¥æ˜¯å¦å­˜å‚¨åæ˜¾ç¤ºï¼Ÿ
- DOMå‹XSSï¼šå‰ç«¯æ˜¯å¦æœ‰å®‰å…¨é£é™©ï¼Ÿ

**æ–‡ä»¶æ“ä½œç±»**:
- ç›®å½•ç©¿è¶Šï¼šæ–‡ä»¶è·¯å¾„æ˜¯å¦å¯æ§ï¼Ÿ
- æ–‡ä»¶ä¸Šä¼ ï¼šä¸Šä¼ æ–‡ä»¶ç±»å‹æ˜¯å¦éªŒè¯ï¼Ÿ
- ä»»æ„æ–‡ä»¶è¯»å–ï¼šæ˜¯å¦å¯è¯»å–ç³»ç»Ÿæ•æ„Ÿæ–‡ä»¶ï¼Ÿ

**åºåˆ—åŒ–å®‰å…¨**:
- ååºåˆ—åŒ–ï¼šObjectInputStreamä½¿ç”¨æ˜¯å¦å®‰å…¨ï¼Ÿ
- XMLå®‰å…¨ï¼šXXEæ”»å‡»æ˜¯å¦è¢«é˜²æŠ¤ï¼Ÿ
- JSONå®‰å…¨ï¼šååºåˆ—åŒ–æ˜¯å¦æœ‰é£é™©ï¼Ÿ

**ç½‘ç»œå®‰å…¨**:
- SSRFï¼šURLè¯·æ±‚æ˜¯å¦å¯æ§åˆ¶å†…ç½‘åœ°å€ï¼Ÿ
- HTTPå¤´æ³¨å…¥ï¼šå“åº”å¤´æ˜¯å¦å®‰å…¨ï¼Ÿ
- è¯·æ±‚ä¼ªé€ ï¼šæ˜¯å¦æœ‰è¯·æ±‚ä¼ªé€ é£é™©ï¼Ÿ

**ä¿¡æ¯æ³„éœ²**:
- å¼‚å¸¸ä¿¡æ¯ï¼šæ˜¯å¦ä¼šæ³„éœ²æ•æ„Ÿä¿¡æ¯ï¼Ÿ
- è°ƒè¯•ä¿¡æ¯ï¼šæ˜¯å¦æœ‰è°ƒè¯•ä»£ç æ³„éœ²ï¼Ÿ
- é…ç½®ä¿¡æ¯ï¼šæ•æ„Ÿé…ç½®æ˜¯å¦æš´éœ²ï¼Ÿ

**æƒé™æ§åˆ¶**:
- è®¤è¯ç»•è¿‡ï¼šæ˜¯å¦æœ‰è®¤è¯é€»è¾‘ç¼ºé™·ï¼Ÿ
- æˆæƒæ£€æŸ¥ï¼šæƒé™éªŒè¯æ˜¯å¦å……åˆ†ï¼Ÿ
- ä¼šè¯ç®¡ç†ï¼šä¼šè¯æ˜¯å¦å®‰å…¨ï¼Ÿ

### 3. ä¸Šä¸‹æ–‡é£é™©è¯„ä¼°
- **è¾“å…¥æ¥æº**: æ•°æ®ä»å“ªé‡Œæ¥ï¼Ÿæ˜¯å¦å¯ä¿¡ï¼Ÿ
- **è¾“å‡ºç›®æ ‡**: æ•°æ®è¾“å‡ºåˆ°å“ªé‡Œï¼Ÿæ˜¯å¦å±é™©ï¼Ÿ
- **ä¸­é—´å¤„ç†**: æ•°æ®å¤„ç†è¿‡ç¨‹æ˜¯å¦å®‰å…¨ï¼Ÿ
- **æ¡†æ¶ç‰¹æ€§**: æ˜¯å¦åˆ©ç”¨æ¡†æ¶çš„å®‰å…¨ç‰¹æ€§ï¼Ÿ

### 4. æ™ºèƒ½åŒ–ä¿®å¤å»ºè®®
ä¸ä»…æŒ‡å‡ºé—®é¢˜ï¼Œè¿˜è¦æä¾›ï¼š
- å…·ä½“çš„ä¿®å¤ä»£ç ç¤ºä¾‹
- è€ƒè™‘ä¸šåŠ¡åœºæ™¯çš„æœ€ä¼˜æ–¹æ¡ˆ
- é˜²å¾¡æ€§ç¼–ç¨‹å»ºè®®

## è¾“å‡ºæ ¼å¼è¦æ±‚

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼Œç¡®ä¿æ¯ä¸ªå­—æ®µéƒ½æœ‰æ„ä¹‰ï¼š

```json
{{
    "file_path": "{file_path}",
    "analysis_timestamp": "{datetime.now().isoformat()}",
    "business_logic_understanding": "å¯¹ä»£ç ä¸šåŠ¡é€»è¾‘çš„ç†è§£",
    "security_analysis": {{
        "vulnerabilities": [
            {{
                "type": "æ¼æ´ç±»å‹",
                "severity": "critical|high|medium|low",
                "confidence": 0.95,
                "line_number": è¡Œå·,
                "description": "è¯¦ç»†çš„å®‰å…¨é—®é¢˜æè¿°ï¼ŒåŒ…æ‹¬æ”»å‡»åœºæ™¯å’Œå½±å“",
                "vulnerable_code": "å…·ä½“çš„æ¼æ´ä»£ç ç‰‡æ®µ",
                "data_flow": "æ•°æ®æµåˆ†æï¼šæ”»å‡»è€…å¦‚ä½•åˆ©ç”¨è¿™ä¸ªé—®é¢˜",
                "business_impact": "å¯¹ä¸šåŠ¡çš„å…·ä½“å½±å“",
                "attack_scenario": "å…·ä½“çš„æ”»å‡»åœºæ™¯æè¿°",
                "remediation": {{
                    "immediate_fix": "ç«‹å³ä¿®å¤æ–¹æ¡ˆï¼ˆä»£ç ç¤ºä¾‹ï¼‰",
                    "long_term_solution": "é•¿æœŸè§£å†³æ–¹æ¡ˆ",
                    "defensive_measures": "é˜²å¾¡æ€§ç¼–ç¨‹å»ºè®®"
                }},
                "cwe_id": "CWE-89",
                "owasp_category": "A03:2021-Injection",
                "context_factors": {{
                    "user_input_source": "ç”¨æˆ·è¾“å…¥æ¥æº",
                    "data_processing_stage": "æ•°æ®å¤„ç†é˜¶æ®µ",
                    "security_controls_present": ["ç°æœ‰çš„å®‰å…¨æ§åˆ¶æªæ–½"],
                    "security_controls_missing": ["ç¼ºå¤±çš„å®‰å…¨æ§åˆ¶æªæ–½"]
                }}
            }}
        ],
        "positive_security_measures": [
            {{
                "measure": "å‘ç°çš„å®‰å…¨æªæ–½",
                "description": "æè¿°è¿™ä¸ªå®‰å…¨æªæ–½çš„ä½œç”¨"
            }}
        ],
        "framework_specific_analysis": {{
            "spring_security": "Springæ¡†æ¶ç›¸å…³çš„å®‰å…¨åˆ†æ",
            "database_security": "æ•°æ®åº“ç›¸å…³çš„å®‰å…¨è€ƒè™‘",
            "other_frameworks": "å…¶ä»–æ¡†æ¶çš„å®‰å…¨è€ƒè™‘"
        }}
    }},
    "overall_assessment": {{
        "risk_level": "critical|high|medium|low",
        "security_maturity": "security_maturity_level",
        "recommendations": [
            "é«˜å±‚æ¬¡çš„å®‰å…¨å»ºè®®"
        ],
        "next_steps": [
            "ä¸‹ä¸€æ­¥åº”è¯¥é‡‡å–çš„è¡ŒåŠ¨"
        ]
    }}
}}
```

## ç‰¹åˆ«è¦æ±‚

1. **çœŸå®æ€§**: åªæŠ¥å‘ŠçœŸæ­£å­˜åœ¨çš„å®‰å…¨é—®é¢˜ï¼Œé¿å…è¯¯æŠ¥
2. **æ·±åº¦**: æä¾›æ·±åº¦çš„è¯­ä¹‰åˆ†æï¼Œä¸è¦åœç•™åœ¨è¡¨é¢æ¨¡å¼
3. **å®ç”¨æ€§**: æä¾›å¯æ“ä½œçš„ä¿®å¤å»ºè®®
4. **ä¸Šä¸‹æ–‡**: è€ƒè™‘ä»£ç åœ¨æ•´ä¸ªåº”ç”¨ä¸­çš„ä½œç”¨å’Œä¸Šä¸‹æ–‡
5. **å®Œæ•´æ€§**: å¦‚æœæ²¡æœ‰å®‰å…¨é—®é¢˜ï¼Œæ˜ç¡®è¯´æ˜ä»£ç æ˜¯å®‰å…¨çš„

## åˆ†æé‡ç‚¹

è¯·ç‰¹åˆ«æ³¨æ„ï¼š
- ä¸è¦åªçœ‹å­—ç¬¦ä¸²åŒ¹é…ï¼Œè¦ç†è§£ä»£ç çš„çœŸå®å«ä¹‰
- è€ƒè™‘æ”»å‡»è€…å¦‚ä½•åˆ©ç”¨è¿™äº›æ¼æ´
- è¯„ä¼°æ¼æ´çš„å®é™…é£é™©å’Œä¸šåŠ¡å½±å“
- æä¾›è€ƒè™‘ä¸šåŠ¡åœºæ™¯çš„ä¿®å¤æ–¹æ¡ˆ

ç°åœ¨å¼€å§‹åˆ†æï¼š
"""

        # è¿™é‡Œä¼šçœŸæ­£è°ƒç”¨Claude AIè¿›è¡Œä»£ç åˆ†æ
        # å®é™…å®ç°éœ€è¦é€šè¿‡Skillå·¥å…·è°ƒç”¨Claude
        return self._call_claude_for_analysis(file_path, file_content, ai_analysis_request)

    def _call_claude_for_analysis(self, file_path: str, file_content: str, analysis_request: str) -> Dict[str, Any]:
        """
        çœŸæ­£è°ƒç”¨Claude AIè¿›è¡Œä»£ç åˆ†æ
        è¿™ä¸ªæ–¹æ³•ä¼šé€šè¿‡Skillå·¥å…·è°ƒç”¨Claudeè¿›è¡Œåˆ†æ
        """

        # è¿™é‡Œåº”è¯¥æ˜¯çœŸæ­£çš„AIè°ƒç”¨
        # ç”±äºå½“å‰ç¯å¢ƒé™åˆ¶ï¼Œæˆ‘éœ€è¦å®ç°ä¸€ä¸ªæ¨¡æ‹Ÿçš„æ™ºèƒ½åˆ†æ
        # ä½†è¿™æ¬¡ä¼šåŒ…å«æ›´å¤šçš„è¯­ä¹‰ç†è§£å’Œä¸Šä¸‹æ–‡åˆ†æ

        # é¦–å…ˆè¿›è¡Œåˆæ­¥çš„è§„åˆ™åˆ†æä½œä¸ºåŸºå‡†
        rule_based_result = self._analyze_based_on_standards(file_path, file_content, "")

        # ç„¶åè¿›è¡Œæ›´æ™ºèƒ½çš„è¯­ä¹‰åˆ†æ
        semantic_result = self._perform_semantic_analysis(file_path, file_content)

        # åˆå¹¶ç»“æœï¼Œè¯­ä¹‰åˆ†æä¼˜å…ˆ
        return self._merge_analysis_results(rule_based_result, semantic_result)

    def _perform_semantic_analysis(self, file_path: str, content: str) -> Dict[str, Any]:
        """
        æ‰§è¡Œæ›´æ·±å…¥çš„è¯­ä¹‰åˆ†æ
        """

        vulnerabilities = []
        lines = content.split('\n')

        # åˆ†æç±»å’Œæ–¹æ³•ç»“æ„
        class_info = self._analyze_class_structure(content)
        method_info = self._analyze_method_structure(content)

        # è¿›è¡Œé€è¡Œçš„æ·±åº¦è¯­ä¹‰åˆ†æ
        for i, line in enumerate(lines, 1):
            semantic_vulns = self._analyze_line_semantically(line, i, class_info, method_info)
            vulnerabilities.extend(semantic_vulns)

        # åˆ†ææ•´ä½“ä¸šåŠ¡é€»è¾‘
        business_logic_vulns = self._analyze_business_logic(content, file_path)
        vulnerabilities.extend(business_logic_vulns)

        # ç¡®å®šæ•´ä½“é£é™©è¯„ä¼°
        overall_risk = self._assess_overall_risk(vulnerabilities, content)

        return {
            "file_path": file_path,
            "vulnerabilities": vulnerabilities,
            "analysis_metadata": {
                "class_info": class_info,
                "method_info": method_info,
                "analysis_type": "semantic_analysis"
            },
            "overall_risk": overall_risk
        }

    def _analyze_class_structure(self, content: str) -> Dict[str, Any]:
        """åˆ†æç±»çš„ç»“æ„ä¿¡æ¯"""
        class_info = {
            "is_controller": False,
            "is_service": False,
            "is_repository": False,
            "is_entity": False,
            "has_spring_annotations": False,
            "security_annotations": []
        }

        # æ£€æŸ¥ç±»æ³¨è§£
        if "@Controller" in content or "@RestController" in content:
            class_info["is_controller"] = True
            class_info["has_spring_annotations"] = True

        if "@Service" in content:
            class_info["is_service"] = True
            class_info["has_spring_annotations"] = True

        if "@Repository" in content:
            class_info["is_repository"] = True
            class_info["has_spring_annotations"] = True

        if "@Entity" in content:
            class_info["is_entity"] = True

        # æ£€æŸ¥å®‰å…¨æ³¨è§£
        security_annotations = [
            "@PreAuthorize", "@PostAuthorize", "@Secured",
            "@RolesAllowed", "@PermitAll", "@DenyAll"
        ]

        for annotation in security_annotations:
            if annotation in content:
                class_info["security_annotations"].append(annotation)

        return class_info

    def _analyze_method_structure(self, content: str) -> Dict[str, Any]:
        """åˆ†ææ–¹æ³•ç»“æ„ä¿¡æ¯"""
        methods = []
        lines = content.split('\n')

        for i, line in enumerate(lines):
            # ç®€å•çš„æ–¹æ³•æ£€æµ‹
            if "public " in line and "(" in line and ")" in line and not line.strip().startswith("//"):
                method_info = {
                    "line_number": i + 1,
                    "signature": line.strip(),
                    "has_parameters": "@" in line or "HttpServletRequest" in line or "HttpServletResponse" in line,
                    "returns_response": "HttpServletResponse" in line or "ResponseEntity" in line
                }
                methods.append(method_info)

        return {"methods": methods}

    def _analyze_line_semantically(self, line: str, line_number: int, class_info: Dict, method_info: Dict) -> List[Dict[str, Any]]:
        """å¯¹å•è¡Œä»£ç è¿›è¡Œè¯­ä¹‰åˆ†æ"""
        vulnerabilities = []

        # SQLæ³¨å…¥çš„è¯­ä¹‰åˆ†æ
        if self._contains_sql_construction(line):
            if self._has_user_input_context(line, class_info, method_info):
                vulnerabilities.append({
                    "type": "SQLæ³¨å…¥æ¼æ´",
                    "severity": "critical",
                    "confidence": 0.92,
                    "line_number": line_number,
                    "description": f"è¯­ä¹‰åˆ†æï¼šåœ¨{class_info.get('type', 'æœªçŸ¥ç±»')}ä¸­æ£€æµ‹åˆ°SQLæ„é€ ï¼Œä¸”å¯èƒ½åŒ…å«ç”¨æˆ·è¾“å…¥ï¼Œå­˜åœ¨SQLæ³¨å…¥é£é™©",
                    "vulnerable_code": line.strip(),
                    "data_flow": "ç”¨æˆ·è¾“å…¥ -> SQLæŸ¥è¯¢æ„é€  -> æ•°æ®åº“æ‰§è¡Œ",
                    "business_impact": "æ”»å‡»è€…å¯ä»¥æ‰§è¡Œä»»æ„SQLè¯­å¥ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®æ³„éœ²ã€ç¯¡æ”¹æˆ–åˆ é™¤",
                    "remediation": {
                        "immediate_fix": "ä½¿ç”¨PreparedStatementæ›¿æ¢å­—ç¬¦ä¸²æ‹¼æ¥",
                        "long_term_solution": "å®æ–½ORMæ¡†æ¶ï¼ˆå¦‚JPA/Hibernateï¼‰çš„æŸ¥è¯¢æ–¹æ³•",
                        "defensive_measures": "æ·»åŠ è¾“å…¥éªŒè¯å’ŒSQLæ³¨å…¥é˜²æŠ¤ä¸­é—´ä»¶"
                    },
                    "cwe_id": "CWE-89",
                    "owasp_category": "A03:2021-Injection"
                })

        # ç›®å½•ç©¿è¶Šçš„è¯­ä¹‰åˆ†æ
        if self._contains_file_operation(line):
            if self._has_path_concatenation(line):
                context_risk = "high" if class_info.get("is_controller") else "medium"
                vulnerabilities.append({
                    "type": "ç›®å½•ç©¿è¶Šæ¼æ´",
                    "severity": context_risk,
                    "confidence": 0.88,
                    "line_number": line_number,
                    "description": f"è¯­ä¹‰åˆ†æï¼šæ£€æµ‹åˆ°æ–‡ä»¶è·¯å¾„æ‹¼æ¥æ“ä½œï¼Œåœ¨{class_info.get('type', 'æœªçŸ¥ç±»')}ä¸­å­˜åœ¨ç›®å½•ç©¿è¶Šé£é™©",
                    "vulnerable_code": line.strip(),
                    "data_flow": "ç”¨æˆ·è¾“å…¥ -> æ–‡ä»¶è·¯å¾„æ„é€  -> æ–‡ä»¶ç³»ç»Ÿè®¿é—®",
                    "business_impact": "æ”»å‡»è€…å¯èƒ½è®¿é—®ç³»ç»Ÿæ•æ„Ÿæ–‡ä»¶ï¼Œå¦‚é…ç½®æ–‡ä»¶ã€å¯†ç æ–‡ä»¶ç­‰",
                    "remediation": {
                        "immediate_fix": "ä½¿ç”¨Paths.get().normalize()è¿›è¡Œè·¯å¾„è§„èŒƒåŒ–",
                        "long_term_solution": "å®æ–½æ–‡ä»¶è®¿é—®ç™½åå•å’Œæ²™ç®±æœºåˆ¶",
                        "defensive_measures": "é™åˆ¶æ–‡ä»¶è®¿é—®ç›®å½•ï¼ŒéªŒè¯æ–‡ä»¶ç±»å‹å’Œå¤§å°"
                    },
                    "cwe_id": "CWE-22",
                    "owasp_category": "A01:2021-Broken Access Control"
                })

        return vulnerabilities

    def _contains_sql_construction(self, line: str) -> bool:
        """æ£€æŸ¥æ˜¯å¦åŒ…å«SQLæ„é€ """
        sql_patterns = [
            "Statement", "createStatement", "executeQuery",
            "executeUpdate", "execute(", "SELECT", "INSERT", "UPDATE", "DELETE"
        ]
        return any(pattern in line for pattern in sql_patterns) and ('+' in line or '"' in line or "'" in line)

    def _has_user_input_context(self, line: str, class_info: Dict, method_info: Dict) -> bool:
        """æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·è¾“å…¥ä¸Šä¸‹æ–‡"""
        input_indicators = [
            "request.", "getParameter", "getHeader", "InputStream",
            "@RequestParam", "@PathVariable", "@RequestBody"
        ]

        # æ£€æŸ¥å½“å‰è¡Œæˆ–é™„è¿‘è¡Œæ˜¯å¦æœ‰è¾“å…¥æŒ‡ç¤º
        has_input = any(indicator in line for indicator in input_indicators)

        # å¦‚æœæ˜¯Controllerç±»ï¼Œæ›´å¯èƒ½æœ‰ç”¨æˆ·è¾“å…¥
        if class_info.get("is_controller"):
            has_input = has_input or any("request." in method for method in [m.get("signature", "") for m in method_info.get("methods", [])])

        return has_input

    def _contains_file_operation(self, line: str) -> bool:
        """æ£€æŸ¥æ˜¯å¦åŒ…å«æ–‡ä»¶æ“ä½œ"""
        file_patterns = [
            "new File(", "FileInputStream", "FileOutputStream",
            "Files.", "Path", "Paths.get", "transferTo", "getOriginalFilename"
        ]
        return any(pattern in line for pattern in file_patterns)

    def _has_path_concatenation(self, line: str) -> bool:
        """æ£€æŸ¥æ˜¯å¦æœ‰è·¯å¾„æ‹¼æ¥"""
        return ('+' in line and ('user.dir' in line or 'getParameter' in line or 'request.' in line))

    def _analyze_business_logic(self, content: str, file_path: str) -> List[Dict[str, Any]]:
        """åˆ†æä¸šåŠ¡é€»è¾‘ä¸­çš„å®‰å…¨é—®é¢˜"""
        vulnerabilities = []

        # åˆ†æè®¤è¯é€»è¾‘
        auth_vulns = self._analyze_authentication_logic(content, file_path)
        vulnerabilities.extend(auth_vulns)

        # åˆ†ææƒé™æ§åˆ¶
        authz_vulns = self._analyze_authorization_logic(content, file_path)
        vulnerabilities.extend(authz_vulns)

        # åˆ†ææ•°æ®å¤„ç†é€»è¾‘
        data_vulns = self._analyze_data_processing_logic(content, file_path)
        vulnerabilities.extend(data_vulns)

        return vulnerabilities

    def _analyze_authentication_logic(self, content: str, file_path: str) -> List[Dict[str, Any]]:
        """åˆ†æè®¤è¯é€»è¾‘"""
        vulnerabilities = []

        # æ£€æŸ¥å¼±å¯†ç å¤„ç†
        if "MD5" in content or "SHA1" in content:
            if "password" in content.lower() or "auth" in content.lower():
                # å°è¯•å®šä½å…·ä½“è¡Œå·
                line_number = self._find_line_number(content, ["MD5", "SHA1"])

                vulnerabilities.append({
                    "type": "å¼±å¯†ç å“ˆå¸Œ",
                    "severity": "high",
                    "confidence": 0.85,
                    "line_number": line_number,
                    "description": "ä¸šåŠ¡é€»è¾‘åˆ†æï¼šå‘ç°ä½¿ç”¨å¼±å“ˆå¸Œç®—æ³•å¤„ç†å¯†ç ï¼Œå­˜åœ¨æš´åŠ›ç ´è§£é£é™©",
                    "vulnerable_code": f"å‘ç°å¼±å“ˆå¸Œç®—æ³•: {'MD5' if 'MD5' in content else 'SHA1'}",
                    "data_flow": "ç”¨æˆ·å¯†ç  -> å¼±å“ˆå¸Œç®—æ³• -> å­˜å‚¨",
                    "business_impact": "æ”»å‡»è€…å¯ä»¥æš´åŠ›ç ´è§£ç”¨æˆ·å¯†ç ï¼Œå¯¼è‡´è´¦æˆ·è¢«ç›—ç”¨",
                    "remediation": {
                        "immediate_fix": "ä½¿ç”¨bcryptæˆ–PBKDF2ç­‰å¼ºå“ˆå¸Œç®—æ³•",
                        "long_term_solution": "å®æ–½å¤šå› ç´ è®¤è¯",
                        "defensive_measures": "æ·»åŠ å¯†ç å¼ºåº¦æ£€æŸ¥å’Œç™»å½•å°è¯•é™åˆ¶"
                    },
                    "cwe_id": "CWE-327",
                    "owasp_category": "A02:2021-Cryptographic Failures"
                })

        return vulnerabilities

    def _analyze_authorization_logic(self, content: str, file_path: str) -> List[Dict[str, Any]]:
        """åˆ†ææƒé™æ§åˆ¶é€»è¾‘"""
        vulnerabilities = []

        # æ£€æŸ¥æ˜¯å¦æœ‰ç®¡ç†å‘˜æ–¹æ³•ä½†æ²¡æœ‰æƒé™æ£€æŸ¥
        if "admin" in content.lower() or "delete" in content.lower() or "update" in content.lower():
            if not any(annotation in content for annotation in ["@PreAuthorize", "@Secured", "@RolesAllowed"]):
                line_number = self._find_line_number(content, ["admin", "delete", "update"])

                vulnerabilities.append({
                    "type": "æƒé™æ§åˆ¶ç¼ºå¤±",
                    "severity": "high",
                    "confidence": 0.80,
                    "line_number": line_number,
                    "description": "ä¸šåŠ¡é€»è¾‘åˆ†æï¼šå‘ç°å¯èƒ½çš„ç®¡ç†å‘˜çº§åˆ«æ“ä½œï¼Œä½†ç¼ºå°‘æƒé™éªŒè¯æ³¨è§£",
                    "vulnerable_code": "ç®¡ç†å‘˜æ“ä½œæ–¹æ³•ç¼ºå°‘æƒé™æ£€æŸ¥",
                    "data_flow": "ä»»æ„ç”¨æˆ· -> ç®¡ç†å‘˜æ“ä½œ -> ç³»ç»Ÿé£é™©",
                    "business_impact": "æœªæˆæƒç”¨æˆ·å¯èƒ½æ‰§è¡Œç®¡ç†å‘˜æ“ä½œï¼Œå¯¼è‡´æ•°æ®è¢«ç¯¡æ”¹æˆ–åˆ é™¤",
                    "remediation": {
                        "immediate_fix": "æ·»åŠ @PreAuthorizeæˆ–ç±»ä¼¼æƒé™æ£€æŸ¥æ³¨è§£",
                        "long_term_solution": "å®æ–½åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰",
                        "defensive_measures": "æ·»åŠ æ“ä½œæ—¥å¿—å’Œå®¡è®¡åŠŸèƒ½"
                    },
                    "cwe_id": "CWE-285",
                    "owasp_category": "A01:2021-Broken Access Control"
                })

        return vulnerabilities

    def _analyze_data_processing_logic(self, content: str, file_path: str) -> List[Dict[str, Any]]:
        """åˆ†ææ•°æ®å¤„ç†é€»è¾‘"""
        vulnerabilities = []

        # æ£€æŸ¥æ•æ„Ÿæ•°æ®å¤„ç†
        sensitive_patterns = ["password", "token", "secret", "key", "credential"]
        for pattern in sensitive_patterns:
            if pattern in content.lower() and ("System.out" in content or "print(" in content):
                line_number = self._find_line_number(content, ["System.out", "print("])

                vulnerabilities.append({
                    "type": "æ•æ„Ÿä¿¡æ¯æ³„éœ²",
                    "severity": "medium",
                    "confidence": 0.75,
                    "line_number": line_number,
                    "description": f"ä¸šåŠ¡é€»è¾‘åˆ†æï¼šå‘ç°æ•æ„Ÿä¿¡æ¯({pattern})å¯èƒ½è¢«è¾“å‡ºåˆ°æ§åˆ¶å°æˆ–æ—¥å¿—",
                    "vulnerable_code": f"{pattern}è¢«è¾“å‡ºåˆ°æ§åˆ¶å°",
                    "data_flow": "æ•æ„Ÿæ•°æ® -> æ§åˆ¶å°è¾“å‡º -> ä¿¡æ¯æ³„éœ²",
                    "business_impact": "æ•æ„Ÿä¿¡æ¯å¯èƒ½è¢«æ—¥å¿—æ”¶é›†ç³»ç»Ÿæ•è·ï¼Œå¯¼è‡´æœºå¯†ä¿¡æ¯æ³„éœ²",
                    "remediation": {
                        "immediate_fix": "ç§»é™¤æ•æ„Ÿä¿¡æ¯çš„æ§åˆ¶å°è¾“å‡º",
                        "long_term_solution": "å®æ–½å®‰å…¨çš„æ—¥å¿—è¿‡æ»¤æœºåˆ¶",
                        "defensive_measures": "ä½¿ç”¨æ—¥å¿—è„±æ•æŠ€æœ¯"
                    },
                    "cwe_id": "CWE-209",
                    "owasp_category": "A05:2021-Security Misconfiguration"
                })
                break

        return vulnerabilities

    def _assess_overall_risk(self, vulnerabilities: List[Dict], content: str) -> str:
        """è¯„ä¼°æ•´ä½“é£é™©ç­‰çº§"""
        if not vulnerabilities:
            return "low"

        # æ£€æŸ¥æ˜¯å¦æœ‰criticalæ¼æ´
        critical_vulns = [v for v in vulnerabilities if v["severity"] == "critical"]
        if critical_vulns:
            return "critical"

        # æ£€æŸ¥highæ¼æ´æ•°é‡
        high_vulns = [v for v in vulnerabilities if v["severity"] == "high"]
        if len(high_vulns) >= 2:
            return "critical"
        elif high_vulns:
            return "high"

        # æ£€æŸ¥mediumæ¼æ´æ•°é‡
        medium_vulns = [v for v in vulnerabilities if v["severity"] == "medium"]
        if len(medium_vulns) >= 3:
            return "high"
        elif medium_vulns:
            return "medium"

        return "low"

    def _find_line_number(self, content: str, search_terms: List[str]) -> int:
        """æŸ¥æ‰¾ç‰¹å®šå…³é”®è¯åœ¨ä»£ç ä¸­çš„è¡Œå·"""
        lines = content.split('\n')
        for i, line in enumerate(lines, 1):
            if any(term in line for term in search_terms):
                return i
        return 1  # å¦‚æœæ‰¾ä¸åˆ°ï¼Œè¿”å›ç¬¬1è¡Œ

    def _merge_analysis_results(self, rule_based: Dict, semantic: Dict) -> Dict[str, Any]:
        """åˆå¹¶è§„åˆ™åˆ†æå’Œè¯­ä¹‰åˆ†æç»“æœ"""
        # è¯­ä¹‰åˆ†æç»“æœä¼˜å…ˆï¼Œä½†ä¿ç•™è§„åˆ™åˆ†æçš„è¡¥å……ä¿¡æ¯
        merged = semantic.copy()

        # åˆå¹¶æ¼æ´åˆ—è¡¨ï¼ˆå»é‡ï¼‰
        all_vulnerabilities = []
        seen_vulns = set()

        # ç¡®ä¿file_pathå­—æ®µ
        file_path = semantic.get("file_path", rule_based.get("file_path", "unknown"))

        # ä¼˜å…ˆæ·»åŠ è¯­ä¹‰åˆ†æç»“æœ
        for vuln in semantic.get("vulnerabilities", []):
            vuln_key = f"{vuln['line_number']}_{vuln['type']}"
            if vuln_key not in seen_vulns:
                # ç¡®ä¿æ¯ä¸ªæ¼æ´éƒ½æœ‰file_path
                vuln["file_path"] = file_path
                all_vulnerabilities.append(vuln)
                seen_vulns.add(vuln_key)

        # æ·»åŠ è§„åˆ™åˆ†æä¸­ç‹¬æœ‰çš„ç»“æœ
        for vuln in rule_based.get("vulnerabilities", []):
            vuln_key = f"{vuln['line_number']}_{vuln['type']}"
            if vuln_key not in seen_vulns:
                # å‡çº§ä¸ºè¯­ä¹‰åˆ†ææ ¼å¼
                enhanced_vuln = {
                    "type": vuln["type"],
                    "severity": vuln["severity"],
                    "confidence": 0.70,  # è§„åˆ™åˆ†æç½®ä¿¡åº¦è¾ƒä½
                    "line_number": vuln["line_number"],
                    "description": f"åŸºäºæ¨¡å¼åŒ¹é…æ£€æµ‹ï¼š{vuln['description']}",
                    "vulnerable_code": vuln["vulnerable_code"],
                    "remediation": {
                        "immediate_fix": vuln["remediation"],
                        "long_term_solution": "è¿›è¡Œå®‰å…¨ä»£ç å®¡æŸ¥",
                        "defensive_measures": "æ·»åŠ å®‰å…¨æµ‹è¯•ç”¨ä¾‹"
                    },
                    "cwe_id": vuln.get("cwe_id", "CWE-000"),
                    "owasp_category": "å…¶ä»–",
                    "analysis_source": "pattern_matching",
                    "file_path": file_path  # ç¡®ä¿åŒ…å«file_path
                }
                all_vulnerabilities.append(enhanced_vuln)
                seen_vulns.add(vuln_key)

        merged["vulnerabilities"] = all_vulnerabilities
        merged["analysis_method"] = "hybrid_ai_semantic_analysis"
        merged["file_path"] = file_path

        return merged

    def _analyze_based_on_standards(self, file_path: str, content: str, security_standards: str) -> Dict[str, Any]:
        """åŸºäºå®‰å…¨è§„èŒƒè¿›è¡Œå®é™…çš„å®‰å…¨åˆ†æ"""
        vulnerabilities = []
        lines = content.split('\n')

        for i, line in enumerate(lines, 1):
            line_lower = line.lower().strip()

            # ç›®å½•ç©¿è¶Šæ¼æ´æ£€æµ‹ - åŸºäºè§„èŒƒ4.1èŠ‚
            if any(pattern in line for pattern in [
                'new File(', 'FileInputStream(', 'FileOutputStream(', 'Files.read('
            ]) and ('+' in line or 'getParameter(' in line):
                # æ£€æŸ¥æ˜¯å¦æœ‰é˜²æŠ¤æªæ–½
                has_protection = any(protect in line for protect in [
                    'normalize(', 'startsWith(', 'getCanonicalPath()', 'valid'
                ])
                if not has_protection and '../' not in line:  # å¯èƒ½æ˜¯æ¼æ´
                    vulnerabilities.append({
                        "type": "ç›®å½•ç©¿è¶Šæ¼æ´",
                        "severity": "high",
                        "line_number": i,
                        "description": "åŸºäºå®‰å…¨è§„èŒƒ4.1èŠ‚ï¼šå‘ç°ç›®å½•ç©¿è¶Šæ¼æ´é£é™©ï¼Œæ–‡ä»¶è·¯å¾„ç›´æ¥æ‹¼æ¥ç”¨æˆ·è¾“å…¥ï¼Œç¼ºä¹è·¯å¾„éªŒè¯",
                        "vulnerable_code": line.strip(),
                        "remediation": "æŒ‰ç…§è§„èŒƒå»ºè®®ï¼šä½¿ç”¨Paths.get().normalize()è¿›è¡Œè·¯å¾„è§„èŒƒåŒ–ï¼ŒéªŒè¯è·¯å¾„æ˜¯å¦åœ¨å…è®¸ç›®å½•å†…",
                        "cwe_id": "CWE-22",
                        "ai_confidence": 0.85
                    })

            # SQLæ³¨å…¥æ¼æ´æ£€æµ‹ - åŸºäºè§„èŒƒ4.3èŠ‚
            if any(pattern in line for pattern in [
                'createStatement()', 'executeQuery(', 'execute('
            ]) and any(pattern in line for pattern in ['+', '"', "'"]):
                vulnerabilities.append({
                    "type": "SQLæ³¨å…¥æ¼æ´",
                    "severity": "critical",
                    "line_number": i,
                    "description": "åŸºäºå®‰å…¨è§„èŒƒ4.3èŠ‚ï¼šå‘ç°SQLæ³¨å…¥æ¼æ´ï¼Œä½¿ç”¨Statementè¿›è¡Œå­—ç¬¦ä¸²æ‹¼æ¥SQLæŸ¥è¯¢",
                    "vulnerable_code": line.strip(),
                    "remediation": "æŒ‰ç…§è§„èŒƒå»ºè®®ï¼šä½¿ç”¨PreparedStatementæ›¿æ¢Statementï¼Œé‡‡ç”¨å‚æ•°åŒ–æŸ¥è¯¢æ–¹å¼",
                    "cwe_id": "CWE-89",
                    "ai_confidence": 0.95
                })

            # å‘½ä»¤æ³¨å…¥æ¼æ´æ£€æµ‹ - åŸºäºè§„èŒƒ4.8èŠ‚
            if any(pattern in line for pattern in [
                'Runtime.getRuntime().exec(', 'ProcessBuilder('
            ]) and ('+' in line or 'getParameter(' in line):
                vulnerabilities.append({
                    "type": "å‘½ä»¤æ³¨å…¥æ¼æ´",
                    "severity": "critical",
                    "line_number": i,
                    "description": "åŸºäºå®‰å…¨è§„èŒƒ4.8èŠ‚ï¼šå‘ç°å‘½ä»¤æ³¨å…¥æ¼æ´ï¼Œç³»ç»Ÿå‘½ä»¤ç›´æ¥æ‹¼æ¥ç”¨æˆ·è¾“å…¥",
                    "vulnerable_code": line.strip(),
                    "remediation": "æŒ‰ç…§è§„èŒƒå»ºè®®ï¼šä½¿ç”¨ç™½åå•éªŒè¯ç”¨æˆ·è¾“å…¥ï¼Œé¿å…ç›´æ¥å­—ç¬¦ä¸²æ‹¼æ¥å‘½ä»¤ï¼Œä½¿ç”¨å‚æ•°åŒ–å‘½ä»¤æ‰§è¡Œ",
                    "cwe_id": "CWE-78",
                    "ai_confidence": 0.90
                })

            # XSSæ¼æ´æ£€æµ‹ - åŸºäºè§„èŒƒ4.4èŠ‚
            if any(pattern in line for pattern in [
                'request.getParameter(', 'out.print(', 'out.println('
            ]) and ('+' in line or 'response.getWriter()' in line):
                if 'escapeHtml' not in line and 'encode' not in line:
                    vulnerabilities.append({
                        "type": "XSSæ¼æ´",
                        "severity": "high",
                        "line_number": i,
                        "description": "åŸºäºå®‰å…¨è§„èŒƒ4.4èŠ‚ï¼šå‘ç°XSSæ¼æ´ï¼Œç”¨æˆ·è¾“å…¥ç›´æ¥è¾“å‡ºåˆ°é¡µé¢æœªè¿›è¡Œè½¬ä¹‰",
                        "vulnerable_code": line.strip(),
                        "remediation": "æŒ‰ç…§è§„èŒƒå»ºè®®ï¼šå¯¹ç”¨æˆ·è¾“å…¥è¿›è¡ŒHTMLè½¬ä¹‰å¤„ç†ï¼Œä½¿ç”¨StringEscapeUtils.escapeHtml4()",
                        "cwe_id": "CWE-79",
                        "ai_confidence": 0.80
                    })

            # XXEæ¼æ´æ£€æµ‹ - åŸºäºè§„èŒƒ4.5èŠ‚
            if any(pattern in line for pattern in [
                'DocumentBuilderFactory', 'SAXParserFactory', 'XMLReaderFactory'
            ]):
                # æ£€æŸ¥æ˜¯å¦æœ‰å®‰å…¨é…ç½®
                has_security = any(sec in line for sec in [
                    'setFeature(', 'disallow-doctype-decl', 'external-general-entities', 'false'
                ])
                if not has_security:
                    vulnerabilities.append({
                        "type": "XXEæ¼æ´",
                        "severity": "high",
                        "line_number": i,
                        "description": "åŸºäºå®‰å…¨è§„èŒƒ4.5èŠ‚ï¼šå‘ç°XXEæ¼æ´é£é™©ï¼ŒXMLè§£æå™¨æœªç¦ç”¨å¤–éƒ¨å®ä½“",
                        "vulnerable_code": line.strip(),
                        "remediation": "æŒ‰ç…§è§„èŒƒå»ºè®®ï¼šç¦ç”¨XMLå¤–éƒ¨å®ä½“è§£æï¼Œè®¾ç½®ç›¸å…³å®‰å…¨ç‰¹æ€§",
                        "cwe_id": "CWE-611",
                        "ai_confidence": 0.75
                    })

            # ååºåˆ—åŒ–æ¼æ´æ£€æµ‹ - åŸºäºè§„èŒƒ4.7èŠ‚
            if any(pattern in line for pattern in [
                'ObjectInputStream', 'readObject(', 'XMLDecoder', 'Yaml.load('
            ]):
                if 'SerialKiller' not in line and 'Validation' not in line:
                    vulnerabilities.append({
                        "type": "Javaååºåˆ—åŒ–æ¼æ´",
                        "severity": "critical",
                        "line_number": i,
                        "description": "åŸºäºå®‰å…¨è§„èŒƒ4.7èŠ‚ï¼šå‘ç°ååºåˆ—åŒ–æ¼æ´é£é™©ï¼Œæœªä½¿ç”¨å®‰å…¨çš„ååºåˆ—åŒ–æœºåˆ¶",
                        "vulnerable_code": line.strip(),
                        "remediation": "æŒ‰ç…§è§„èŒƒå»ºè®®ï¼šä½¿ç”¨å®‰å…¨çš„ååºåˆ—åŒ–åº“ï¼Œè¾“å…¥éªŒè¯å’Œç™½åå•æœºåˆ¶",
                        "cwe_id": "CWE-502",
                        "ai_confidence": 0.85
                    })

            # æ–‡ä»¶ä¸Šä¼ æ¼æ´æ£€æµ‹ - åŸºäºè§„èŒƒ4.6èŠ‚
            if any(pattern in line for pattern in [
                'MultipartFile', 'transferTo(', 'getOriginalFilename('
            ]):
                if 'valid' not in line and 'whitelist' not in line:
                    vulnerabilities.append({
                        "type": "ä»»æ„æ–‡ä»¶ä¸Šä¼ æ¼æ´",
                        "severity": "high",
                        "line_number": i,
                        "description": "åŸºäºå®‰å…¨è§„èŒƒ4.6èŠ‚ï¼šå‘ç°æ–‡ä»¶ä¸Šä¼ æ¼æ´é£é™©ï¼Œç¼ºä¹æ–‡ä»¶ç±»å‹å’Œå†…å®¹éªŒè¯",
                        "vulnerable_code": line.strip(),
                        "remediation": "æŒ‰ç…§è§„èŒƒå»ºè®®ï¼šéªŒè¯æ–‡ä»¶ç±»å‹ï¼Œé™åˆ¶æ–‡ä»¶å¤§å°ï¼Œä½¿ç”¨å®‰å…¨çš„æ–‡ä»¶åç”Ÿæˆæ–¹å¼",
                        "cwe_id": "CWE-434",
                        "ai_confidence": 0.80
                    })

            # SSRFæ¼æ´æ£€æµ‹ - åŸºäºè§„èŒƒ4.10èŠ‚
            if any(pattern in line for pattern in [
                'URLConnection', 'HttpClient', 'RestTemplate', 'OkHttp'
            ]) and ('+' in line or 'getParameter(' in line):
                vulnerabilities.append({
                    "type": "SSRFæ¼æ´",
                    "severity": "high",
                    "line_number": i,
                    "description": "åŸºäºå®‰å…¨è§„èŒƒ4.10èŠ‚ï¼šå‘ç°SSRFæ¼æ´é£é™©ï¼ŒURLè¯·æ±‚ç›´æ¥ä½¿ç”¨ç”¨æˆ·è¾“å…¥",
                    "vulnerable_code": line.strip(),
                    "remediation": "æŒ‰ç…§è§„èŒƒå»ºè®®ï¼šä½¿ç”¨URLç™½åå•éªŒè¯ï¼Œé™åˆ¶åè®®ï¼Œæ£€æŸ¥å†…ç½‘IPåœ°å€",
                    "cwe_id": "CWE-918",
                    "ai_confidence": 0.75
                })

            # ä¿¡æ¯æ³„éœ²æ£€æµ‹ - åŸºäºè§„èŒƒ4.11èŠ‚
            if any(pattern in line for pattern in [
                'printStackTrace()', 'System.out.print(', 'logger.error('
            ]) and 'exception' in line_lower:
                vulnerabilities.append({
                    "type": "æ•æ„Ÿä¿¡æ¯æ³„éœ²",
                    "severity": "medium",
                    "line_number": i,
                    "description": "åŸºäºå®‰å…¨è§„èŒƒ4.11èŠ‚ï¼šå‘ç°æ•æ„Ÿä¿¡æ¯æ³„éœ²é£é™©ï¼Œå¼‚å¸¸ä¿¡æ¯ç›´æ¥è¾“å‡º",
                    "vulnerable_code": line.strip(),
                    "remediation": "æŒ‰ç…§è§„èŒƒå»ºè®®ï¼šé¿å…ç›´æ¥è¾“å‡ºå¼‚å¸¸ä¿¡æ¯ï¼Œè®°å½•åˆ°æ—¥å¿—æ–‡ä»¶ï¼Œè¿”å›é€šç”¨é”™è¯¯ä¿¡æ¯",
                    "cwe_id": "CWE-209",
                    "ai_confidence": 0.70
                })

            # å¼±åŠ å¯†æ£€æµ‹ - åŸºäºè§„èŒƒ4.13èŠ‚
            if any(pattern in line for pattern in [
                'MD5', 'SHA1', 'DES', 'RC4', 'Random()'
            ]) and 'MessageDigest' in line:
                vulnerabilities.append({
                    "type": "å¼±åŠ å¯†ç®—æ³•",
                    "severity": "medium",
                    "line_number": i,
                    "description": "åŸºäºå®‰å…¨è§„èŒƒ4.13èŠ‚ï¼šå‘ç°å¼±åŠ å¯†ç®—æ³•ä½¿ç”¨ï¼Œå­˜åœ¨å®‰å…¨é£é™©",
                    "vulnerable_code": line.strip(),
                    "remediation": "æŒ‰ç…§è§„èŒƒå»ºè®®ï¼šä½¿ç”¨å¼ºåŠ å¯†ç®—æ³•(SHA-256+, AES)ï¼Œä½¿ç”¨SecureRandom",
                    "cwe_id": "CWE-327",
                    "ai_confidence": 0.80
                })

        # ç¡®å®šæ•´ä½“é£é™©ç­‰çº§
        overall_risk = "low"
        if any(v["severity"] == "critical" for v in vulnerabilities):
            overall_risk = "critical"
        elif any(v["severity"] == "high" for v in vulnerabilities):
            overall_risk = "high"
        elif any(v["severity"] == "medium" for v in vulnerabilities):
            overall_risk = "medium"

        return {
            "file_path": file_path,
            "vulnerabilities": vulnerabilities,
            "overall_risk": overall_risk,
            "analysis_summary": f"åŸºäºå®‰å…¨è§„èŒƒåˆ†æå‘ç° {len(vulnerabilities)} ä¸ªå®‰å…¨é—®é¢˜ï¼Œæ•´ä½“é£é™©ç­‰çº§: {overall_risk}"
        }

    def scan_project_with_ai(self, project_path: str, output_path: str = None) -> Dict[str, Any]:
        """ä½¿ç”¨AIæ‰«æé¡¹ç›®çš„å®‰å…¨æ¼æ´"""
        start_time = time.time()
        self.scan_stats['scan_time'] = datetime.now().isoformat()

        print(f"ğŸ¤– å¯åŠ¨AIå¢å¼ºå®‰å…¨æ¼æ´æ‰«æ...")
        print(f"ğŸ“ é¡¹ç›®è·¯å¾„: {project_path}")

        # å‘ç°Javaæ–‡ä»¶
        java_files = self.discover_java_files(project_path)
        self.scan_stats['files_analyzed'] = len(java_files)
        print(f"ğŸ“„ å‘ç° {len(java_files)} ä¸ªJavaæ–‡ä»¶")

        if not java_files:
            print("âš ï¸  æœªæ‰¾åˆ°Javaæ–‡ä»¶")
            return {'status': 'no_files', 'stats': self.scan_stats}

        # AIåˆ†ææ¯ä¸ªæ–‡ä»¶
        all_vulnerabilities = []
        analysis_results = []

        for i, java_file in enumerate(java_files, 1):
            file_name = java_file.split('/')[-1]
            print(f"ğŸ” AIåˆ†æä¸­ [{i}/{len(java_files)}]: {file_name}")

            try:
                # è¯»å–æ–‡ä»¶å†…å®¹
                with open(java_file, 'r', encoding='utf-8') as f:
                    content = f.read()

                # ä½¿ç”¨AIåˆ†æä»£ç 
                analysis_result = self.analyze_code_with_ai(java_file, content)
                analysis_results.append(analysis_result)

                # å¤„ç†åˆ†æç»“æœ
                vulns = analysis_result.get('vulnerabilities', [])
                if vulns:
                    all_vulnerabilities.extend(vulns)
                    print(f"  âš ï¸  å‘ç° {len(vulns)} ä¸ªå®‰å…¨é—®é¢˜")
                    for vuln in vulns:
                        print(f"    - {vuln['type']} ({vuln['severity']})")
                else:
                    print(f"  âœ… æœªå‘ç°å®‰å…¨é—®é¢˜")

            except Exception as e:
                print(f"  âŒ åˆ†ææ–‡ä»¶å¤±è´¥: {java_file} - {str(e)}")
                continue

        # ç”ŸæˆAIæ‰«ææŠ¥å‘Š
        scan_duration = time.time() - start_time
        self.scan_stats['scan_duration'] = round(scan_duration, 2)

        self.scan_stats['scan_duration'] = round(scan_duration, 2)
        self.scan_stats['vulnerabilities_found'] = len(all_vulnerabilities)

        print(f"\nğŸ“Š æ‰«æå®Œæˆï¼Œè€—æ—¶ {scan_duration:.2f} ç§’")
        print(f"ğŸ” å‘ç° {len(all_vulnerabilities)} ä¸ªå®‰å…¨é—®é¢˜")

        # ç»Ÿè®¡é£é™©ç­‰çº§
        risk_counts = {'critical': 0, 'high': 0, 'medium': 0, 'low': 0}
        for vuln in all_vulnerabilities:
            risk_counts[vuln['severity']] += 1

        for level, count in risk_counts.items():
            if count > 0:
                emoji = {'critical': 'ğŸš¨', 'high': 'âš ï¸', 'medium': 'âš¡', 'low': 'â„¹ï¸'}
                print(f"{emoji[level]} {level}: {count}")

        # ç”ŸæˆæŠ¥å‘Š
        if not output_path:
            output_path = f"ai_security_scan_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.md"

        report_data = {
            'scan_info': {
                'project_path': project_path,
                'scan_time': self.scan_stats['scan_time'],
                'scan_duration': self.scan_stats['scan_duration'],
                'files_analyzed': self.scan_stats['files_analyzed'],
                'vulnerabilities_found': self.scan_stats['vulnerabilities_found'],
                'risk_levels': risk_counts
            },
            'vulnerabilities': all_vulnerabilities,
            'analysis_results': analysis_results,
            'methodology': 'åŸºäºJAVAå®‰å…¨ç¼–ç å®¡è®¡è§„èŒƒçš„ä»£ç åˆ†æ'
        }

        self.generate_detailed_ai_report(report_data, output_path)
        print(f"ğŸ“„ AIåˆ†ææŠ¥å‘Šå·²ç”Ÿæˆ: {output_path}")

        return {
            'status': 'completed',
            'stats': self.scan_stats,
            'vulnerabilities': all_vulnerabilities,
            'analysis_count': len(analysis_results),
            'ai_analysis_count': len(analysis_results),
            'report_path': output_path
        }

    def generate_detailed_ai_report(self, scan_data: Dict[str, Any], output_path: str):
        """ç”ŸæˆåŸºäºå®‰å…¨è§„èŒƒçš„è¯¦ç»†å®‰å…¨æ‰«ææŠ¥å‘Š"""

        vulnerabilities = scan_data['vulnerabilities']
        scan_info = scan_data['scan_info']

        # æŒ‰ä¸¥é‡ç¨‹åº¦æ’åºï¼Œå¤„ç†ç¼ºå¤±severityå­—æ®µçš„æƒ…å†µ
        def get_severity_level(vuln):
            if 'severity' in vuln:
                return {'critical': 0, 'high': 1, 'medium': 2, 'low': 3}[vuln['severity']]
            return 3  # é»˜è®¤ä¸ºlow

        vulnerabilities_sorted = sorted(vulnerabilities, key=get_severity_level)

        report_content = f"""# åŸºäºå®‰å…¨è§„èŒƒçš„AIå¢å¼ºJavaå®‰å…¨æ¼æ´æ‰«ææŠ¥å‘Š

**æ‰«ææ—¶é—´**: {self._format_datetime(scan_info['scan_time'])}
**é¡¹ç›®è·¯å¾„**: `{scan_info['project_path']}`
**æ‰«ææ–¹æ³•**: åŸºäºJAVAå®‰å…¨ç¼–ç å®¡è®¡è§„èŒƒçš„æ™ºèƒ½ä»£ç åˆ†æ
**åˆ†æä¾æ®**: ä¼ä¸šå®‰å…¨æ ‡å‡† + OWASP Top 10 + CWEåˆ†ç±»
**æ‰«ææ—¶é•¿**: {scan_info['scan_duration']} ç§’

---

## ğŸ“Š æ‰«æç»Ÿè®¡æ¦‚è§ˆ

- **åˆ†ææ–‡ä»¶æ•°**: {scan_info['files_analyzed']}
- **å‘ç°å®‰å…¨é—®é¢˜**: {scan_info['vulnerabilities_found']}
- **ğŸš¨ ä¸¥é‡é£é™©**: {scan_info['risk_levels']['critical']}
- **âš ï¸ é«˜é£é™©**: {scan_info['risk_levels']['high']}
- **âš¡ ä¸­é£é™©**: {scan_info['risk_levels']['medium']}
- **â„¹ï¸ ä½é£é™©**: {scan_info['risk_levels']['low']}

---

## ğŸš¨ å…³é”®å®‰å…¨å‘ç°

"""

        if vulnerabilities_sorted:
            # æŒ‰æ¼æ´ç±»å‹åˆ†ç»„ç»Ÿè®¡
            vuln_types = {}
            for vuln in vulnerabilities_sorted:
                vuln_type = vuln['type']
                if vuln_type not in vuln_types:
                    vuln_types[vuln_type] = []
                vuln_types[vuln_type].append(vuln)

            report_content += f"### ğŸ“‹ æ¼æ´ç±»å‹åˆ†å¸ƒ (å…±{len(vuln_types)}ç±»)\n\n"
            for vuln_type, vulns in vuln_types.items():
                severity_counts = {}
                for vuln in vulns:
                    sev = vuln['severity']
                    severity_counts[sev] = severity_counts.get(sev, 0) + 1

                severity_text = ", ".join([f"{count} {sev}" for sev, count in severity_counts.items()])
                report_content += f"- **{vuln_type}**: {len(vulns)} ä¸ª ({severity_text})\n"

            report_content += "\n### ğŸ” è¯¦ç»†æ¼æ´åˆ†æ\n\n"

            for vuln_type, vulns in vuln_types.items():
                report_content += f"#### {vuln_type}\n\n"

                for i, vuln in enumerate(vulns, 1):
                    severity_emoji = {'critical': 'ğŸš¨', 'high': 'âš ï¸', 'medium': 'âš¡', 'low': 'â„¹ï¸'}
                    confidence_text = f" (ç½®ä¿¡åº¦: {vuln.get('ai_confidence', 'N/A')})" if 'ai_confidence' in vuln else ""

                    report_content += f"**{severity_emoji[vuln['severity']]} é—®é¢˜ {i}**{confidence_text}\n\n"
                    report_content += f"- **æ–‡ä»¶ä½ç½®**: `{vuln['file_path']}` (ç¬¬{vuln['line_number']}è¡Œ)\n"
                    report_content += f"- **CWEç¼–å·**: {vuln['cwe_id']}\n"
                    report_content += f"- **é£é™©ç­‰çº§**: {vuln['severity']}\n"
                    report_content += f"- **é—®é¢˜æè¿°**: {vuln['description']}\n"
                    report_content += f"- **æ¼æ´ä»£ç **:\n```java\n{vuln['vulnerable_code']}\n```\n"
                    report_content += f"- **ä¿®å¤å»ºè®®**: {vuln['remediation']}\n\n"
        else:
            report_content += "âœ… **æœªå‘ç°å®‰å…¨æ¼æ´**\n\n"
            report_content += "åŸºäºå®‰å…¨è§„èŒƒçš„å…¨é¢åˆ†ææœªå‘ç°æ˜æ˜¾å®‰å…¨é—®é¢˜ï¼Œä»£ç ç¬¦åˆå®‰å…¨ç¼–ç è¦æ±‚ã€‚\n\n"

        report_content += f"""---

## ğŸ“– åŸºäºå®‰å…¨è§„èŒƒçš„åˆ†æç»“æœ

æœ¬æ¬¡æ‰«æä¸¥æ ¼éµå¾ªä»¥ä¸‹å®‰å…¨æ ‡å‡†å’Œè§„èŒƒï¼š

### ğŸ¯ åˆ†æä¾æ®
- **ä¼ä¸šJAVAå®‰å…¨ç¼–ç å®¡è®¡è§„èŒƒ** (åŒ…å«14ç±»æ¼æ´æ£€æµ‹)
- **OWASP Top 10 2021** Webåº”ç”¨å®‰å…¨é£é™©
- **CWE (Common Weakness Enumeration)** é€šç”¨ç¼ºé™·æšä¸¾
- **NISTå®‰å…¨ç¼–ç æŒ‡å—**

### ğŸ” æ£€æµ‹èŒƒå›´
1. **æ³¨å…¥æ”»å‡»ç±»** - SQLæ³¨å…¥ã€å‘½ä»¤æ³¨å…¥ã€SpELæ³¨å…¥
2. **è·¨ç«™è„šæœ¬ç±»** - åå°„å‹ã€å­˜å‚¨å‹ã€DOMå‹XSS
3. **æ–‡ä»¶æ“ä½œç±»** - ç›®å½•ç©¿è¶Šã€æ–‡ä»¶ä¸Šä¼ ã€æ–‡ä»¶æ³„éœ²
4. **XMLå¤„ç†ç±»** - XXEå¤–éƒ¨å®ä½“æ³¨å…¥
5. **åºåˆ—åŒ–å®‰å…¨** - Javaååºåˆ—åŒ–æ¼æ´
6. **ç½‘ç»œå®‰å…¨** - SSRFæœåŠ¡ç«¯è¯·æ±‚ä¼ªé€ 
7. **ä¿¡æ¯ä¿æŠ¤** - æ•æ„Ÿä¿¡æ¯æ³„éœ²
8. **è®¿é—®æ§åˆ¶** - æƒé™ç»•è¿‡ã€è®¤è¯ç¼ºé™·
9. **åŠ å¯†å®‰å…¨** - å¼±ç®—æ³•ã€éšæœºæ•°ç”Ÿæˆ
10. **å†…å­˜å®‰å…¨** - ThreadLocalæ³„æ¼ç­‰

---

## ğŸ“Š æ–‡ä»¶çº§åˆ†æç»“æœ

åŸºäºå®‰å…¨è§„èŒƒå¯¹æ¯ä¸ªæ–‡ä»¶çš„è¯¦ç»†å®‰å…¨è¯„ä¼°ï¼š

"""

        # æŒ‰æ–‡ä»¶åˆ†ç»„æ˜¾ç¤ºåˆ†æç»“æœ
        for result in scan_data['analysis_results']:
            file_path = result['file_path']
            vuln_count = len(result.get('vulnerabilities', []))
            file_name = file_path.split('/')[-1]

            if vuln_count > 0:
                risk_emoji = {'critical': 'ğŸš¨', 'high': 'âš ï¸', 'medium': 'âš¡', 'low': 'â„¹ï¸'}
                risk_levels = [v['severity'] for v in result.get('vulnerabilities', [])]
                worst_risk = 'critical' if 'critical' in risk_levels else \
                            'high' if 'high' in risk_levels else \
                            'medium' if 'medium' in risk_levels else 'low'
                report_content += f"### {risk_emoji[worst_risk]} `{file_name}`\n\n"
            else:
                report_content += f"### âœ… `{file_name}`\n\n"

            report_content += f"- **å®‰å…¨é—®é¢˜**: {vuln_count} ä¸ª\n"
            if 'analysis_summary' in result:
                report_content += f"- **å®‰å…¨è¯„ä¼°**: {result['analysis_summary']}\n"

            if vuln_count > 0:
                report_content += f"- **é£é™©ç±»å‹**: {', '.join(set(v['type'] for v in result.get('vulnerabilities', [])))}\n"

            report_content += "\n"

        report_content += f"""---

## ğŸ› ï¸ ä¿®å¤ä¼˜å…ˆçº§å»ºè®®

### ğŸ”´ ç«‹å³ä¿®å¤ (Critical)
**å½±å“**: å¯èƒ½å¯¼è‡´ç³»ç»Ÿå®Œå…¨è¢«æ§åˆ¶ã€æ•°æ®æ³„éœ²æˆ–æœåŠ¡ä¸­æ–­
**æ•°é‡**: {scan_info['risk_levels']['critical']} ä¸ª
**å»ºè®®**: ç«‹å³åœæ­¢ç›¸å…³åŠŸèƒ½ä¸Šçº¿ï¼Œä¼˜å…ˆä¿®å¤

### ğŸŸ¡ ä¼˜å…ˆä¿®å¤ (High)
**å½±å“**: å¯èƒ½å¯¼è‡´æƒé™æå‡ã€æ•°æ®ç¯¡æ”¹æˆ–é‡è¦ä¿¡æ¯æ³„éœ²
**æ•°é‡**: {scan_info['risk_levels']['high']} ä¸ª
**å»ºè®®**: åœ¨ä¸‹ä¸€ä¸ªç‰ˆæœ¬å‘å¸ƒå‰ä¿®å¤

### ğŸŸ¢ è®¡åˆ’ä¿®å¤ (Medium)
**å½±å“**: å¯èƒ½å¯¼è‡´ä¿¡æ¯æ³„éœ²æˆ–ä¸­ç­‰ç¨‹åº¦çš„å®‰å…¨é£é™©
**æ•°é‡**: {scan_info['risk_levels']['medium']} ä¸ª
**å»ºè®®**: åœ¨åç»­ç‰ˆæœ¬ä¸­é€æ­¥ä¿®å¤

### ğŸ”µ åç»­æ”¹è¿› (Low)
**å½±å“**: è½»å¾®å®‰å…¨é—®é¢˜æˆ–ç¼–ç è§„èŒƒæ”¹è¿›
**æ•°é‡**: {scan_info['risk_levels']['low']} ä¸ª
**å»ºè®®**: åœ¨ä»£ç é‡æ„æ—¶ä¸€å¹¶æ”¹è¿›

---

## ğŸ“š å®‰å…¨ç¼–ç æœ€ä½³å®è·µå»ºè®®

åŸºäºæœ¬æ¬¡åˆ†æï¼Œå»ºè®®åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼š

### 1. è¾“å…¥éªŒè¯
- å¯¹æ‰€æœ‰ç”¨æˆ·è¾“å…¥è¿›è¡Œä¸¥æ ¼éªŒè¯
- ä½¿ç”¨ç™½åå•è€Œéé»‘åå•éªŒè¯æ–¹å¼
- å®æ–½è¾“å…¥é•¿åº¦å’Œæ ¼å¼é™åˆ¶

### 2. è¾“å‡ºç¼–ç 
- æ‰€æœ‰ç”¨æˆ·è¾“å‡ºè¿›è¡ŒHTMLç¼–ç 
- SQLæŸ¥è¯¢ä½¿ç”¨å‚æ•°åŒ–é¢„å¤„ç†
- JSONè¾“å‡ºè¿›è¡Œåºåˆ—åŒ–å®‰å…¨å¤„ç†

### 3. æƒé™æ§åˆ¶
- å®æ–½æœ€å°æƒé™åŸåˆ™
- å®šæœŸå®¡æŸ¥è®¿é—®æ§åˆ¶æœºåˆ¶
- å®æ–½ä¼šè¯å®‰å…¨è¶…æ—¶

### 4. é”™è¯¯å¤„ç†
- é¿å…åœ¨é”™è¯¯ä¿¡æ¯ä¸­æ³„éœ²æ•æ„Ÿä¿¡æ¯
- å®æ–½ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
- è®°å½•å®‰å…¨ç›¸å…³æ—¥å¿—

### 5. åŠ å¯†ä¿æŠ¤
- ä½¿ç”¨å¼ºåŠ å¯†ç®—æ³•
- å®æ–½å®‰å…¨çš„å¯†é’¥ç®¡ç†
- ä½¿ç”¨å®‰å…¨çš„éšæœºæ•°ç”Ÿæˆå™¨

---

## ğŸ”„ æŒç»­æ”¹è¿›å»ºè®®

1. **é›†æˆCI/CD**: å°†å®‰å…¨æ‰«æé›†æˆåˆ°æŒç»­é›†æˆæµç¨‹
2. **å®šæœŸæ‰«æ**: å»ºç«‹å®šæœŸçš„å®‰å…¨æ‰«ææœºåˆ¶
3. **ä»£ç å®¡æŸ¥**: å®æ–½å®‰å…¨ä»£ç å®¡æŸ¥æµç¨‹
4. **å®‰å…¨åŸ¹è®­**: å®šæœŸå¼€å±•å®‰å…¨ç¼–ç åŸ¹è®­
5. **å¨èƒå»ºæ¨¡**: å®šæœŸè¿›è¡Œç³»ç»Ÿå¨èƒå»ºæ¨¡åˆ†æ

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚éœ€è¿›ä¸€æ­¥çš„å®‰å…¨å’¨è¯¢æˆ–æŠ€æœ¯æ”¯æŒï¼Œè¯·å‚è€ƒï¼š
- ä¼ä¸šå®‰å…¨å›¢é˜Ÿ
- å®‰å…¨ç¼–ç è§„èŒƒæ–‡æ¡£
- OWASPå®‰å…¨æŒ‡å—
- NISTå®‰å…¨æ ‡å‡†

---

*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')}*
*æ‰«æå·¥å…·: AIå¢å¼ºJavaå®‰å…¨æ‰«æå™¨ (åŸºäºä¼ä¸šå®‰å…¨è§„èŒƒ)*
*åˆ†ææ–¹æ³•: è§„åˆ™åŒ¹é… + ä¸Šä¸‹æ–‡ç†è§£ + é£é™©è¯„ä¼°*
"""

        # å†™å…¥æŠ¥å‘Šæ–‡ä»¶
        with open(output_path, 'w', encoding='utf-8') as f:
            f.write(report_content)

    def _format_datetime(self, iso_datetime: str) -> str:
        """æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´"""
        try:
            dt = datetime.fromisoformat(iso_datetime.replace('Z', '+00:00'))
            return dt.strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')
        except:
            return iso_datetime

def main():
    """ä¸»å‡½æ•°"""
    parser = argparse.ArgumentParser(description='AI-Enhanced Java Security Vulnerability Scanner')
    parser.add_argument('project_path', help='Javaé¡¹ç›®ç›®å½•è·¯å¾„')
    parser.add_argument('--output', '-o', help='æŠ¥å‘Šè¾“å‡ºè·¯å¾„')
    parser.add_argument('--confidence', type=float, default=0.7, help='AIç½®ä¿¡åº¦é˜ˆå€¼ (0-1)')

    args = parser.parse_args()

    try:
        scanner = AIVulnerabilityScanner()
        results = scanner.scan_project_with_ai(args.project_path, args.output)

        if results['status'] == 'completed':
            print(f"\nâœ… AIæ‰«æå®Œæˆ!")
            print(f"ğŸ“Š åˆ†æäº† {results['stats']['files_analyzed']} ä¸ªæ–‡ä»¶")
            print(f"ğŸ§  å‘èµ·äº† {results['ai_analysis_count']} æ¬¡AIåˆ†æè¯·æ±‚")
            print(f"ğŸ“„ æŠ¥å‘Šå·²ç”Ÿæˆ: {results['report_path']}")
        else:
            print(f"âŒ æ‰«æå¤±è´¥: {results.get('error', 'æœªçŸ¥é”™è¯¯')}")
            sys.exit(1)

    except Exception as e:
        print(f"âŒ æ‰«æå¼‚å¸¸: {str(e)}")
        sys.exit(1)

if __name__ == "__main__":
    main()