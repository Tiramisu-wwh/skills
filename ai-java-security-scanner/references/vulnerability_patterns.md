# Java Security Vulnerability Patterns

This document defines the vulnerability patterns and detection rules used by the Java Security Vulnerability Scanner.

## Overview

The vulnerability patterns are organized by category, with each pattern containing:
- **Description**: Detailed explanation of the vulnerability
- **Detection Patterns**: Regular expressions and code patterns
- **Context Indicators**: Factors that increase risk assessment
- **Mitigation Indicators**: Code patterns that reduce risk
- **Remediation Guidelines**: Recommended fixes

## Critical Risk Vulnerabilities

### SQL Injection (CWE-89)

**Description**: SQL injection occurs when untrusted data is included in SQL queries without proper validation or parameterization, allowing attackers to execute arbitrary SQL commands.

**Detection Patterns**:
```regex
executeQuery\s*\(\s*["\'].*\+.*["\']
execute\s*\(\s*["\'].*\+.*["\']
createStatement\s*\(\s*\)
prepareStatement\s*\(\s*["\'].*\+.*["\']
Statement\s+\w+\s*=.*createStatement
String\s+\w+\s*=\s*["\'].*\+.*["\'];.*execute
```

**High-Risk Contexts**:
- User input sources: `request.getParameter()`, `request.getQueryString()`
- Direct string concatenation in SQL queries
- Dynamic SQL construction
- Database access without input validation

**Mitigation Indicators**:
- `PreparedStatement` usage with parameter binding (`?` placeholders)
- `setParameter()` method calls
- Input validation and sanitization
- Stored procedure usage
- ORM framework usage (JPA, Hibernate)

**Remediation**:
```java
// Vulnerable
String query = "SELECT * FROM users WHERE id = " + userId;
Statement stmt = connection.createStatement();
ResultSet rs = stmt.executeQuery(query);

// Secure
String query = "SELECT * FROM users WHERE id = ?";
PreparedStatement pstmt = connection.prepareStatement(query);
pstmt.setString(1, userId);
ResultSet rs = pstmt.executeQuery();
```

### Command Injection (CWE-78)

**Description**: Command injection occurs when untrusted data is used to construct system commands, allowing attackers to execute arbitrary commands on the host system.

**Detection Patterns**:
```regex
Runtime\.getRuntime\s*\(\s*\)\.exec\s*\(\s*["\'].*\+.*
ProcessBuilder\s*\([^)]*\+.*
exec\s*\(\s*["\'].*\+.*
system\s*\(\s*["\'].*\+.*
popen\s*\(\s*["\'].*\+.*
cmd\s*/c.*\+
powershell.*\+
```

**High-Risk Contexts**:
- User input in command strings
- File names from user input
- Command-line arguments from web requests
- Shell metacharacters: `;`, `&`, `|`, `>`, `<`

**Mitigation Indicators**:
- Input validation with whitelisting
- Parameterized command execution
- Restricted command sets
- Proper escaping and sanitization

**Remediation**:
```java
// Vulnerable
String command = "ls " + userInput;
Runtime.getRuntime().exec(command);

// Secure
// Validate input against allowed values
if (!isValidDirectory(userInput)) {
    throw new SecurityException("Invalid directory");
}
String[] command = {"ls", userInput};
Runtime.getRuntime().exec(command);
```

### Unsafe Deserialization (CWE-502)

**Description**: Unsafe deserialization occurs when untrusted data is deserialized without proper validation, potentially leading to remote code execution.

**Detection Patterns**:
```regex
ObjectInputStream\s*\([^)]+\)
readObject\s*\(\s*\)
XMLDecoder\s*\([^)]+\)
Yaml\s*\([^)]+load
Gson\s*\([^)]+fromJson
Jackson.*readValue
ObjectMapper.*readValue
```

**High-Risk Contexts**:
- Deserializing user-provided data
- Network-based deserialization
- Legacy serialization formats
- XML configuration parsing

**Mitigation Indicators**:
- Input validation before deserialization
- Safe deserialization libraries
- Digital signature verification
- Allowlist of permitted classes

**Remediation**:
```java
// Vulnerable
ObjectInputStream ois = new ObjectInputStream(inputStream);
Object obj = ois.readObject();

// Secure
// Validate input size and format
if (!isValidSerializedData(inputStream)) {
    throw new SecurityException("Invalid serialized data");
}
ObjectInputStream ois = new ObjectInputStreamWithFilter(inputStream, filter);
Object obj = ois.readObject();
```

## High Risk Vulnerabilities

### Path Traversal (CWE-22)

**Description**: Path traversal allows attackers to access files and directories outside the intended web root by manipulating file paths.

**Detection Patterns**:
```regex
new\s+File\s*\(\s*["\'].*\+.*["\']
FileInputStream\s*\(\s*["\'].*\+.*["\']
FileOutputStream\s*\(\s*["\'].*\+.*["\']
Files\.read\s*\(\s*Paths\.get\s*\(\s*["\'].*\+
getCanonicalPath\s*\(\s*\).*\+
getAbsolutePath\s*\(\s*\).*\+
```

**Dangerous Sequences**: `../`, `..\\`, `/etc/`, `/proc/`, `C:\\`

**Remediation**:
```java
// Vulnerable
String filePath = baseDir + userFileName;
File file = new File(filePath);

// Secure
Path userPath = Paths.get(userFileName);
if (userPath.isAbsolute() || userPath.normalize().startsWith("..")) {
    throw new SecurityException("Invalid file path");
}
Path resolvedPath = baseDir.resolve(userPath).normalize();
File file = resolvedPath.toFile();
```

### Cross-Site Scripting (XSS) (CWE-79)

**Description**: XSS occurs when untrusted data is included in web pages without proper encoding, allowing attackers to inject malicious scripts.

**Detection Patterns**:
```regex
request\.getParameter\s*\([^)]+\)
request\.getQueryString\s*\(\s*\)
request\.getHeader\s*\([^)]+\)
out\.print\s*\([^)]*\+
out\.write\s*\([^)]*\+
response\.getWriter\s*\(\s*\)\.print
```

**Remediation**:
```java
// Vulnerable
out.println("Hello, " + request.getParameter("name"));

// Secure
String name = request.getParameter("name");
String encodedName = StringEscapeUtils.escapeHtml4(name);
out.println("Hello, " + encodedName);
```

## Medium Risk Vulnerabilities

### Information Disclosure (CWE-200)

**Description**: Information disclosure occurs when sensitive information is exposed to unauthorized users through error messages, logs, or responses.

**Detection Patterns**:
```regex
System\.out\.print
System\.err\.print
printStackTrace\s*\(\s*\)
e\.getMessage\s*\(\s*\).*out
logger\.error.*exception
```

**Remediation**:
```java
// Vulnerable
catch (Exception e) {
    e.printStackTrace();
}

// Secure
catch (Exception e) {
    logger.error("Error processing request", e);
    // Return generic error message to user
    return "An error occurred. Please try again.";
}
```

### Weak Cryptography (CWE-327)

**Description**: Use of weak cryptographic algorithms or improper random number generation can compromise data security.

**Detection Patterns**:
```regex
MD5\s*\(\s*\)
SHA1\s*\(\s*\)
DES\s*\(\s*\)
RC4\s*\(\s*\)
random\s*\(\s*\)
Math\.random\s*\(\s*\)
```

**Remediation**:
```java
// Vulnerable
MessageDigest md5 = MessageDigest.getInstance("MD5");
Random rand = new Random(); // Uses current time as seed

// Secure
MessageDigest sha256 = MessageDigest.getInstance("SHA-256");
SecureRandom secureRandom = SecureRandom.getInstanceStrong();
```

## Detection Algorithm

The scanner uses a multi-layered approach:

1. **Pattern Matching**: Regular expressions identify potential vulnerability signatures
2. **Context Analysis**: Examines surrounding code for risk amplification factors
3. **Semantic Analysis**: Understands code flow and data dependencies
4. **Risk Scoring**: Combines multiple factors to assign accurate risk levels

### Risk Calculation Formula

```
Base Risk Score + Context Score - Mitigation Score = Final Risk Score

Risk Levels:
- Critical: Score >= 8
- High: Score >= 5
- Medium: Score >= 2
- Low: Score < 2
```

### Context Boosters

- User Input: +2 points
- Network Input: +3 points
- File Operations: +2 points
- Database Operations: +3 points
- Command Execution: +4 points
- Web Response Output: +2 points

### Mitigation Indicators

- Parameterized Queries: -3 points
- Input Validation: -2 points
- Output Escaping: -2 points
- Whitelist Validation: -3 points
- Authentication/Authorization: -2 points

## False Positive Reduction

To minimize false positives, the scanner:

1. **Requires Context**: Patterns must appear in appropriate context
2. **Mitigation Detection**: Recognizes common security patterns
3. **Framework Awareness**: Understands Spring Security, authentication frameworks
4. **Data Flow Analysis**: Tracks input from source to sink
5. **Configuration Analysis**: Examines security configuration files

## Customization

Organizations can customize detection rules by:

1. **Adding Patterns**: Include organization-specific vulnerability patterns
2. **Adjusting Risk Scores**: Modify risk weights based on organizational priorities
3. **Framework Rules**: Add rules for custom frameworks and libraries
4. **Compliance Mappings**: Map vulnerabilities to compliance standards (PCI DSS, HIPAA, etc.)

## References

- OWASP Top 10: https://owasp.org/www-project-top-ten/
- CWE (Common Weakness Enumeration): https://cwe.mitre.org/
- NIST Secure Coding Standards: https://csrc.nist.gov/projects/
- SANS Top 25: https://www.sans.org/top25-software-errors/